<p>
	<h2>Nuevo Anuncio</h2>
</p>
<p>
	<label>Descripción</label><textarea cols="30" rows="5" id="descripcion"></textarea><br>
</p>
<p>
	<label for="selectCategoria">Categoría:</label>
	<select id="selectCategoria">
		<option>	</option>
	</select>
</p>
<p>
<form id="formFoto" enctype="multipart/form-data" style="display:block;">
	<label for="foto">Fotos:</label><input type="file" id="foto" name="foto" accept="image/*">
	<br>
	<button type="button" id="guardar" onclick="subirFoto()">Subir</button>
</form>
</p>

<script>
var request = new XMLHttpRequest();
request.open("GET", "getCategorias.jsp");
request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
request.onreadystatechange=function(){
	if (request.readyState==4){
		if (request.status==200) {
			var respuesta = JSON.parse(request.responseText);
			for (var i=0; i<respuesta.length; i++){
				var option=document.createElement("option");
				option.setAttribute("value", respuesta[i].id);
				option.innerHTML=respuesta[i].nombre;
				var select = document.getElementById("selectCategoria");
				select.appendChild(option);
			}
		}else{
			alert("Error. "+request.statusText);
		}
	}
};
request.send();

function subirFoto(){
	var req = new XMLHttpRequest();
	//var progreso = document.getElementById("progreso");
	var f=document.getElementById("formFoto");
	var formData = new FormData(f);
	req.open("POST", "SubirFoto.action")
	req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	req.onreadystatechange=function(){
		if (req.readyState==3){
			//progreso.innerHTML="Respuesta recibida";
		}
		if (req.readyState==4) {
			if (req.status==200){
				var respuesta = req.responseText;
				respuesta = JSON.parse(respuesta);
				//progreso.innerHTML="Foto subida correctamente con Id= "+ respuesta.mensaje;
				//mostrarFoto();
				alert(respuesta.resultado);
			}else {
				alert("Error. "+ request.statusText);
			}
		}
	};
	req.send(formData);
}

function insertarAnuncio(){
	var req = new XMLHttpRequest();
	req.open("POST", "NuevoAnuncio.action")
	req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	req.onreadystatechange=function(){
		if (req.readyState==4) {
			if (req.status==200){
				var respuesta = req.responseText;
				respuesta = JSON.parse(respuesta);
				alert(respuesta.resultado);
			}else {
				alert("Error. "+ request.statusText);
			}
		}
	};
	
	var descripcion = document.getElementById("descripcion").value;
	var categoria = document.getElementById("selectCategoria").value;
	
	var pars = "descripcion="+descripcion+"&categoria="+categoria
	var uri = encodeURI(pars);
	req.send(uri);
}
</script>
<button type="submit" onclick="insertarAnuncio()">Publicar</button>